<!-- 

    Documented : anfas 13-OCT
    renewed : anfas 13-OCT

-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Analyzer</title>
    
    <!-- Basecoat UI CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/basecoat-css@0.3.2/dist/basecoat.cdn.min.css">
    <script src="https://cdn.jsdelivr.net/npm/basecoat-css@0.3.2/dist/js/all.min.js" defer></script>
    
    {% load static %}
    <link rel="stylesheet" href="{% static 'src/styles.css' %}">
    
</head>
<body>
    <div class="main-container">
        <div class="form-container vercel-gradient">
            <div class="card">
                <div class="card-header">
                    <h1 class="card-title title text-2xl font-bold">Voice Analyzer</h1>
                </div>
                
                <div class="card-content space-y-6">
                    <div class="instructions p-4 rounded-lg">
                        <p class="font-semibold mb-2">How to register:</p>
                        <ol class="list-decimal list-inside space-y-1 text-sm text-muted-foreground">
                            <li>Click "Start Recording" and speak clearly for 3 seconds</li>
                            <li>Click on Analyze Button</li>
                        </ol>
                    </div>
                    
                    <form method="post" enctype="multipart/form-data" id="registrationForm" class="space-y-4">
                        <!-- CSRF token placeholder for Django -->
                        {% csrf_token %}
                        
                        <div class="space-y-2">
                            <label for="username" class="label">Username</label>
                            <input type="text" id="username" name="username" required 
                                   placeholder="Enter your username" 
                                   class="input w-full">
                        </div>
                        
                        <!-- <div class="space-y-2">
                            <label for="password" class="label">Password</label>
                            <input type="password" id="password" name="password" required 
                                   placeholder="Enter your password" 
                                   class="input w-full">
                        </div>
                         -->
                        <div class="space-y-2">
                            <label for="voice_note" class="label">Voice Recording</label>
                            <label for="voice_note" class="help_text">Help text</label>
                            <button type="button" class="btn record-btn w-full py-3" id="recordButton">
                                <span class="icon">●</span> Start Recording
                            </button>
                            <input type="file" id="voice_note" name="voice_note" accept="audio/*" class="hidden" required>
                            <audio id="audioPlayback" controls class="hidden rounded-lg"></audio>
                        </div>
                        
                        <button type="submit" class="btn submit-btn w-full py-3 font-semibold">
                            Analyze Voice
                        </button>
                    </form>
                    
                    <div class="alert hidden" id="statusMessage" role="alert"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const recordButton = document.getElementById('recordButton');
            const voiceNoteInput = document.getElementById('voice_note');
            const audioPlayback = document.getElementById('audioPlayback');
            const statusMessage = document.getElementById('statusMessage');
            
            let mediaRecorder;
            let audioChunks = [];
            
            // Check if browser supports audio recording
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showStatus('Your browser does not support audio recording. Please use a modern browser like Chrome or Firefox.', 'error');
                recordButton.disabled = true;
            }
            
            recordButton.addEventListener('click', function() {
                if (this.classList.contains('recording')) {
                    stopRecording();
                    this.classList.remove('recording');
                    this.innerHTML = '<span class="icon">●</span> Start Recording';
                } else {
                    startRecording();
                    this.classList.add('recording');
                    this.innerHTML = '<span class="icon">⏹</span> Stop Recording';
                }
            });
            
            async function startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    
                    mediaRecorder.ondataavailable = function(event) {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = function() {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        
                        // Create a File object from the Blob
                        const audioFile = new File([audioBlob], 'recording.webm', { type: 'audio/webm' });
                        
                        // Create a DataTransfer object to set the file input
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(audioFile);
                        voiceNoteInput.files = dataTransfer.files;
                        
                        // Create a URL for playback
                        const audioUrl = URL.createObjectURL(audioBlob);
                        audioPlayback.src = audioUrl;
                        audioPlayback.classList.remove('hidden');
                        
                        // Stop all tracks
                        mediaRecorder.stream.getTracks().forEach(track => track.stop());
                        
                        showStatus('Recording saved successfully!', 'success');
                    };
                    
                    mediaRecorder.start();
                    audioChunks = [];
                    
                    // Automatically stop after 5 seconds
                    setTimeout(() => {
                        if (mediaRecorder && mediaRecorder.state === 'recording') {
                            recordButton.click();
                        }
                    }, 5000);
                    
                } catch (error) {
                    console.error('Error accessing microphone:', error);
                    showStatus('Error accessing microphone. Please check permissions.', 'error');
                }
            }
            
            function stopRecording() {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }
            }
            
            function showStatus(message, type) {
                statusMessage.textContent = message;
                statusMessage.className = `alert alert-${type}`;
                statusMessage.classList.remove('hidden');
                
                // Hide status after 5 seconds
                setTimeout(() => {
                    statusMessage.classList.add('hidden');
                }, 5000);
            }
            
            // Form submission handling
            document.getElementById('registrationForm').addEventListener('submit', function(e) {
                if (!voiceNoteInput.files.length) {
                    e.preventDefault();
                    showStatus('Please record your voice before submitting.', 'error');
                    return false;
                }
                
                showStatus('Submitting registration...', 'info');
            });
        });
    </script>
</body>
</html>