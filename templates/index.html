<!-- 

    Documented : anfas 13-OCT
    renewed : anfas 13-OCT

-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Voice Authentication Registration</title>

    <!-- Basecoat UI CDN -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/basecoat-css@0.3.2/dist/basecoat.cdn.min.css"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/basecoat-css@0.3.2/dist/js/all.min.js"
      defer
    ></script>

    {% load static %}
    <!-- <link rel="stylesheet" href="{% static 'src/styles.css' %}" importance="high" /> -->
    <style>
      /* input {
        background-color: white !important;
      } */

      :root {
            /* Dark Vercel theme variables */
            --background: #ffffff;
            --foreground: #000000;
            --card-foreground: #000000;
            --card: #fafafa;
            --popover-foreground: #0a0a0a;
            --popover: #fafafa;
            --primary-foreground: #fafafa;
            --primary: #0a0a0a;
            --secondary-foreground: #262626;
            --secondary: #fafafa;
            --muted-foreground: #262626;
            --muted: #a1a1aa;
            --accent-foreground: #262626;
            --accent: #fafafa;
            --destructive-foreground: #dc2626;
            --destructive: #000000;
            --border: #ffffff;
            --input: #fbfbfb;
            --ring: #000000;
        }

        body {
            /* background: linear-gradient(135deg, #ffffff 0%, #e6e6e6 50%, #f1f1f1 100%); */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            margin: 0;
            color: var(--foreground);
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        .main-container {
            width: 100%;
            max-width: 500px;
        }
        
        .form-container {
            background: var(--card);
            border: 1px solid var(--border);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .vercel-gradient {
            background: linear-gradient(135deg, rgba(241, 241, 241, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .title {
            background: linear-gradient(135deg, #000000 0%, #282828 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }
        
        .record-btn {
            transition: all 0.2s ease;
            border: 1px solid var(--border);
            background: var(--secondary);
            color: var(--secondary-foreground);
        }
        
        .record-btn:hover {
            background: var(--accent);
            border-color: var(--ring);
            color: var(--accent-foreground);
        }
        
        .record-btn.recording {
            background: var(--destructive);
            border-color: var(--destructive);
            color: var(--destructive-foreground);
            animation: pulse 1.5s infinite;
        }
        
        .submit-btn {
            background: var(--primary);
            color: var(--primary-foreground);
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }
        
        .submit-btn:hover {
            background: var(--secondary);
            color: var(--foreground);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            50% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
        
        .instructions {
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid #3b82f6;
            border-radius: 0 8px 8px 0;
        }
        
        .icon {
            font-size: 18px;
            margin-right: 8px;
        }
        
        .hidden {
            display: none;
        }
        
        /* Custom audio controls styling */
        audio {
            width: 100%;
            margin-top: 10px;
            border-radius: 6px;
            background:white;
        }
        
        audio::-webkit-media-controls-panel {
            background:white;
        }
        
        /* Override Basecoat styles */
        .input {
            background-color: white !important;
            border: 1px solid !important;
            border-color: var(--border);
            color: var(--foreground);
        }
        
        .input:focus {
            border-color: var(--ring);
            box-shadow: 0 0 0 2px rgba(212, 212, 216, 0.2);
        }
        
        .label {
            color: var(--foreground);
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-top: 16px;
        }
        
        .alert-success {
            background-color: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            color: rgb(34, 197, 94);
        }
        
        .alert-destructive {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: rgb(239, 68, 68);
        }
        
        .alert-info {
            background-color: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            color: rgb(59, 130, 246);
        }
        
        .card {
            background: transparent;
            border: none;
        }
        
        .card-header {
            padding: 24px 24px 0;
        }
        
        .card-content {
            padding: 24px;
        }
        
        .card-title {
            margin-bottom: 0;
        }
        
        .space-y-6 > * + * {
            margin-top: 24px;
        }
        
        .space-y-4 > * + * {
            margin-top: 16px;
        }
        
        .space-y-2 > * + * {
            margin-top: 8px;
        }
        
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .text-muted-foreground {
            color: var(--muted-foreground);
        }
        
        .text-2xl {
            font-size: 1.5rem;
            line-height: 2rem;
        }
        
        .font-bold {
            font-weight: 700;
        }
        
        .font-semibold {
            font-weight: 600;
        }
        
        .p-4 {
            padding: 24px;
        }
        
        .rounded-lg {
            border-radius: 8px;
        }
        
        .list-decimal {
            list-style-type: decimal;
        }
        
        .list-inside {
            list-style-position: inside;
        }
        
        .space-y-1 > * + * {
            margin-top: 4px;
        }
        
        .text-sm {
            font-size: 0.875rem;
            line-height: 1.25rem;
        }
        
        .mb-2 {
            margin-bottom: 8px;
        }
        
        .w-full {
            width: 100%;
        }
        
        .py-3 {
            padding-top: 12px;
            padding-bottom: 12px;
        }

        #recordButton {
          border: 1px solid !important;
          border-color: var(--ring);
        }
    </style>
  </head>
  <body>
    <div class="main-container">
      <div class="form-container vercel-gradient">
        <div class="card">
          <div class="card-header">
            <h1 class="card-title title text-2xl font-bold">
              Voice Analyzer
            </h1>
          </div>

          <div class="card-content space-y-6">
            <div class="instructions p-4 rounded-lg">
              <p class="font-semibold mb-2">How it works:</p>
              <ol
                class="list-decimal list-inside space-y-1 text-sm text-muted-foreground"
              >
                <li>Enter a username</li>
                <li>Click "Start Recording" and speak clearly for 15 seconds</li>
                <li>Submit your voice recording</li>
                <li>It will analyze your voice and provide feedback.</li>
              </ol>
            </div>

            <form
              method="post"
              enctype="multipart/form-data"
              id="registrationForm"
              class="space-y-4"
            >
              <!-- CSRF token placeholder for Django -->
              {% csrf_token %}

              <div class="space-y-2">
                <label for="username" class="label">Username</label>
                <input
                  type="text"
                  id="username"
                  name="username"
                  required
                  placeholder="Enter your username"
                  class="input w-full"
                />
              </div>

              <div class="space-y-2">
                <label for="voice_note" class="label">Voice Recording</label>
                <button
                  type="button"
                  class="btn record-btn w-full py-3"
                  id="recordButton"
                >
                  <span class="icon">‚óè</span> Start Recording
                </button>
                <input
                  type="file"
                  id="voice_note"
                  name="voice_note"
                  accept="audio/*"
                  class="hidden"
                  required
                />
                <audio
                  id="audioPlayback"
                  controls
                  class="hidden rounded-lg"
                ></audio>
              </div>

              <button
                type="submit"
                class="btn submit-btn w-full py-3 font-semibold"
              >
                Register
              </button>
            </form>

            <!-- Results Section - Shows after form submission -->
           {% if analysis_result %}
<div class="results-section alert-success">
    <h3 class="font-bold text-lg mb-3">üéâ Real Voice Analysis Results</h3>
    
    <div class="space-y-2 mb-4">
        <p><strong>Username:</strong> {{ username }}</p>
        <p><strong>Voice File:</strong> {{ voice_file }}</p>
        <p><strong>Analysis Method:</strong> {{ analysis_result.analysis_method }}</p>
    </div>
    
    {% if analysis_result.error %}
        <div class="alert alert-destructive mt-3">
            <strong>Error:</strong> {{ analysis_result.error }}
        </div>
    {% else %}
        <!-- Acoustic Features -->
        <div class="mt-4">
            <h4 class="font-semibold mb-2">üîä Acoustic Features:</h4>
            <div class="grid grid-cols-2 gap-3">
                <div class="feature-card">
                    <strong>Energy:</strong> {{ analysis_result.energy|floatformat:4 }}
                </div>
                <div class="feature-card">
                    <strong>Zero Crossing Rate:</strong> {{ analysis_result.zero_crossing_rate|floatformat:4 }}
                </div>
                <div class="feature-card">
                    <strong>Spectral Centroid:</strong> {{ analysis_result.spectral_centroid|floatformat:0 }} Hz
                </div>
                <div class="feature-card">
                    <strong>Fundamental Freq:</strong> {{ analysis_result.fundamental_frequency|floatformat:0 }} Hz
                </div>
            </div>
        </div>
        
        <!-- Voice Assessment -->
        <div class="mt-4">
            <h4 class="font-semibold mb-2">üé§ Voice Assessment:</h4>
            <div class="grid grid-cols-2 gap-3">
                <div class="feature-card">
                    <strong>Voice Quality:</strong> {{ analysis_result.voice_quality }}
                </div>
                <div class="feature-card">
                    <strong>Volume Level:</strong> {{ analysis_result.volume_level }}
                </div>
                <div class="feature-card">
                    <strong>Pitch Level:</strong> {{ analysis_result.pitch_level }}
                </div>
                <div class="feature-card">
                    <strong>Articulation:</strong> {{ analysis_result.articulation }}
                </div>
            </div>
        </div>
        
        <!-- Speech Recognition Results -->
        <div class="mt-4 p-3 bg-blue-50 rounded">
            <h4 class="font-semibold mb-2">üí¨ Speech Recognition:</h4>
            <p><strong>Spoken Text:</strong> <em>"{{ analysis_result.spoken_text }}"</em></p>
            <p><strong>Speech Detected:</strong> {{ analysis_result.speech_detected|yesno:"Yes,No" }}</p>
        </div>
        
        <!-- Technical Details -->
        <div class="mt-3 text-sm text-gray-600">
            <p><strong>Duration:</strong> {{ analysis_result.duration_seconds|floatformat:2 }} seconds</p>
            <p><strong>Sample Rate:</strong> {{ analysis_result.sample_rate }} Hz</p>
            <p><strong>Confidence:</strong> {{ analysis_result.confidence|floatformat:3 }}</p>
        </div>
    {% endif %}
    
    <button onclick="resetForm()" class="btn record-btn mt-4">
        Analyze Another Voice
    </button>
</div>
{% endif %}
<p id="loadingText" style="display:none; color:blue; font-weight:bold;">
  Processing your audio, please wait...
</p>
            <div class="alert hidden" id="statusMessage" role="alert"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      function resetForm() {
          document.getElementById('registrationForm').reset();
          window.location.href = window.location.href.split('?')[0]; // Reload without query params
      }
      document.addEventListener("DOMContentLoaded", function () {
        const recordButton = document.getElementById("recordButton");
        const voiceNoteInput = document.getElementById("voice_note");
        const audioPlayback = document.getElementById("audioPlayback");
        const statusMessage = document.getElementById("statusMessage");

        let mediaRecorder;
        let audioChunks = [];

        // Check if browser supports audio recording
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          showStatus(
            "Your browser does not support audio recording. Please use a modern browser like Chrome or Firefox.",
            "error"
          );
          recordButton.disabled = true;
        }

        recordButton.addEventListener("click", function () {
          if (this.classList.contains("recording")) {
            stopRecording();
            this.classList.remove("recording");
            this.innerHTML = '<span class="icon">‚óè</span> Start Recording';
          } else {
            startRecording();
            this.classList.add("recording");
            this.innerHTML = '<span class="icon">‚èπ</span> Stop Recording';
          }
        });

        async function startRecording() {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              audio: {
                channelCount: 1,
                sampleRate: 16000,
                sampleSize: 16,
              },
            });

            mediaRecorder = new MediaRecorder(stream, {
              mimeType: "audio/webm;codecs=opus",
            });

            mediaRecorder.ondataavailable = function (event) {
              if (event.data.size > 0) {
                audioChunks.push(event.data);
              }
            };

            mediaRecorder.onstop = function () {
              const audioBlob = new Blob(audioChunks, { type: "audio/webm" });

              // Create a more descriptive filename
              const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
              const filename = `recording-${timestamp}.webm`;

              // Create a File object with proper filename
              const audioFile = new File([audioBlob], filename, {
                type: "audio/webm",
                lastModified: new Date().getTime(),
              });

              // Create a DataTransfer object to set the file input
              const dataTransfer = new DataTransfer();
              dataTransfer.items.add(audioFile);
              voiceNoteInput.files = dataTransfer.files;

              // Create a URL for playback
              const audioUrl = URL.createObjectURL(audioBlob);
              audioPlayback.src = audioUrl;
              audioPlayback.classList.remove("hidden");

              // Stop all tracks
              stream.getTracks().forEach((track) => track.stop());

              showStatus(`Recording saved as ${filename}`, "success");
              console.log("File ready for upload:", audioFile); // Debug
            };

            mediaRecorder.start(1000); // Collect data every second
            audioChunks = [];

            // Automatically stop after 15 seconds
            setTimeout(() => {
              if (mediaRecorder && mediaRecorder.state === "recording") {
                stopRecording();
                recordButton.classList.remove("recording");
                recordButton.innerHTML =
                  '<span class="icon">‚óè</span> Start Recording';
              }
            }, 15000);
          } catch (error) {
            console.error("Error accessing microphone:", error);
            showStatus(
              "Error accessing microphone. Please check permissions.",
              "error"
            );
          }
        }

        function stopRecording() {
          if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
          }
        }

        function showStatus(message, type) {
          statusMessage.textContent = message;
          statusMessage.className = `alert alert-${type}`;
          statusMessage.classList.remove("hidden");

          // Hide status after 5 seconds
          setTimeout(() => {
            statusMessage.classList.add("hidden");
          }, 10000);
        }

        // Form submission handling
        document
          .getElementById("registrationForm")
          .addEventListener("submit", function (e) {
            
            if (!voiceNoteInput.files.length) {
              e.preventDefault();
              showStatus(
                "Please record your voice before submitting.",
                "error"
              );
              return false;
            }

            showStatus("Submitting registration...", "info");
          });
      });
    </script>
  </body>
</html>
