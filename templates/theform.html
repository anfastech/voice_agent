<!-- 

    Documented : anfas 13-OCT
    renewed : anfas 13-OCT

-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The form</title>

    <!-- Basecoat UI CDN -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/basecoat-css@0.3.2/dist/basecoat.cdn.min.css"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/basecoat-css@0.3.2/dist/js/all.min.js"
      defer
    ></script>

    {% load static %}
    <link rel="stylesheet" href="{% static 'src/styles.css' %}" />
  </head>
  <body>
    <div class="main-container">
      <div class="form-container vercel-gradient">
        <div class="card">
          <div class="card-header">
            <h1 class="card-title title text-2xl font-bold">Voice Analyzer</h1>
          </div>

          <div class="card-content space-y-6">
            <div class="instructions p-4 rounded-lg">
              <p class="font-semibold mb-2">How to register:</p>
              <ol
                class="list-decimal list-inside space-y-1 text-sm text-muted-foreground"
              >
                <li>Click "Start Recording" and speak clearly for 3 seconds</li>
                <li>Click on Analyze Button</li>
              </ol>
            </div>

            <form
              method="post"
              enctype="multipart/form-data"
              id="registrationForm"
              class="space-y-4"
            >
              {% csrf_token %} 
                {% if form.errors %}
                <div class="alert alert-destructive">
                  <strong>Please correct the following errors:</strong>
                  <ul>
                    {% for field in form %} 
                      {% for error in field.errors %}
                      <li>{{ field.label }}: {{ error }}</li>
                      {% endfor %} 
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                      <li>{{ error }}</li>
                    {% endfor %}
                  </ul>
                </div>
                {% endif %}

              <!-- Username Field -->
              <div class="space-y-2">
                <label for="{{ form.username.id_for_label }}" class="label">
                  {{ form.username.label }}
                </label>
                {{ form.username }} 
                {% if form.username.help_text %}
                <small class="help_text">{{ form.username.help_text }}</small>
                {% endif %}
              </div>

              <!-- Voice Recording Field with Custom Button -->
              <div class="space-y-2">
                <label for="{{ form.voice_note.id_for_label }}" class="label">
                  {{ form.voice_note.label }}
                </label>

                <!-- Custom Recording Button -->
                <button
                  type="button"
                  class="btn record-btn w-full py-3"
                  id="recordButton"
                >
                  <span class="icon">●</span> Start Recording
                </button>

                <!-- Django's file input (hidden, controlled by JavaScript) -->
                {{ form.voice_note }}

                <!-- Audio playback -->
                <audio
                  id="audioPlayback"
                  controls
                  class="hidden rounded-lg"
                ></audio>

                {% if form.voice_note.help_text %}
                <small class="help_text">{{ form.voice_note.help_text }}</small>
                {% endif %}
              </div>

              <button
                type="submit"
                class="btn submit-btn w-full py-3 font-semibold"
              >
                Analyze Voice
              </button>
            </form>

            <div class="alert hidden" id="statusMessage" role="alert"></div>
            
            <div class="alert hidden" id="resultMessage" role="alert"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const recordButton = document.getElementById("recordButton");
        const voiceNoteInput = document.getElementById("voice_note");
        const audioPlayback = document.getElementById("audioPlayback");
        const statusMessage = document.getElementById("statusMessage");

        let mediaRecorder;
        let audioChunks = [];

        // Check if browser supports audio recording
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          showStatus(
            "Your browser does not support audio recording. Please use a modern browser like Chrome or Firefox.",
            "error"
          );
          recordButton.disabled = true;
        }

        recordButton.addEventListener("click", function () {
          if (this.classList.contains("recording")) {
            stopRecording();
            this.classList.remove("recording");
            this.innerHTML = '<span class="icon">●</span> Start Recording';
          } else {
            startRecording();
            this.classList.add("recording");
            this.innerHTML = '<span class="icon">⏹</span> Stop Recording';
          }
        });

        async function startRecording() {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              audio: true,
            });
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = function (event) {
              audioChunks.push(event.data);
            };

            mediaRecorder.onstop = function () {
              const audioBlob = new Blob(audioChunks, { type: "audio/webm" });

              // Create a File object from the Blob
              const audioFile = new File([audioBlob], "recording.webm", {
                type: "audio/webm",
              });

              // Create a DataTransfer object to set the file input
              const dataTransfer = new DataTransfer();
              dataTransfer.items.add(audioFile);
              voiceNoteInput.files = dataTransfer.files;

              // Create a URL for playback
              const audioUrl = URL.createObjectURL(audioBlob);
              audioPlayback.src = audioUrl;
              audioPlayback.classList.remove("hidden");

              // Stop all tracks
              stream.getTracks().forEach((track) => track.stop());

              showStatus("Recording saved successfully!", "success");
            };

            mediaRecorder.start();
            audioChunks = [];

            // Automatically stop after 5 seconds
            setTimeout(() => {
              if (mediaRecorder && mediaRecorder.state === "recording") {
                recordButton.click();
              }
            }, 3000);
          } catch (error) {
            console.error("Error accessing microphone:", error);
            showStatus(
              "Error accessing microphone. Please check permissions.",
              "error"
            );
          }
        }

        function stopRecording() {
          if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
          }
        }

        function showStatus(message, type) {
          statusMessage.textContent = message;
          statusMessage.className = `alert alert-${type}`;
          statusMessage.classList.remove("hidden");

          setTimeout(() => {
            statusMessage.classList.add("hidden");
          }, 5000);
        }
      });
    </script>
  </body>
</html>
